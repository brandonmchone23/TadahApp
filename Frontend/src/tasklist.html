<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Tadah App</title>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    .task-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .task-checkbox {
      margin-right: 10px;
    }

    .task-title {
      flex-grow: 1;
    }

    .delete-button {
      cursor: pointer;
    }
  </style>
</head>
<body class="background">
<header class="header" id="header">
  <div class="site-title">
    <a class="header_home" href="main.html.js.html">Tadah App</a>
  </div>
</header>
<div id="myDIV" class="header">
  <h2>My To-Do List</h2>
  <input type="text" id="myInput" placeholder="Title...">
  <button onclick="addTask()" class="addBtn">Add</button>
</div>

<div id="taskList"></div>

<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
  function fetchTasks() {
    fetch('/tasks')
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to fetch tasks');
              }
              return response.json();
            })
            .then(tasks => {
              const taskListElement = document.getElementById('taskList');
              taskListElement.innerHTML = ''; // Clear the task list

              tasks.forEach(task => {
                const taskRow = document.createElement('div');
                taskRow.classList.add('task-row');

                const taskCheckbox = document.createElement('input');
                taskCheckbox.type = 'checkbox';
                taskCheckbox.checked = task.completed;
                taskCheckbox.classList.add('task-checkbox');
                taskCheckbox.addEventListener('change', () => markTaskAsComplete(task.taskId, taskCheckbox.checked));
                taskRow.appendChild(taskCheckbox);

                const taskTitle = document.createElement('span');
                taskTitle.innerHTML = task.taskTitle; // Use innerHTML to decode HTML entities
                taskTitle.classList.add('task-title');
                taskRow.appendChild(taskTitle);

                const deleteButton = document.createElement('span');
                deleteButton.textContent = '🗑️';
                deleteButton.classList.add('delete-button');
                deleteButton.addEventListener('click', () => deleteTask(task.taskId));
                taskRow.appendChild(deleteButton);

                taskListElement.appendChild(taskRow);
              });
            })
            .catch(error => {
              console.error(error);
            });
  }

  async function addTask() {
    const taskTitleInput = document.getElementById("myInput");
    const taskTitle = taskTitleInput.value.trim();

    if (taskTitle === "") {
      return;
    }

    const task = { taskTitle, isCompleted: false };
    const response = await fetch("/tasks", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(task),
    });

    if (response.ok) {
      taskTitleInput.value = "";
      fetchTasks(); // Refresh the tasks list after adding a new task
    }
  }

  async function markTaskAsComplete(taskId, isCompleted) {
    const updatedTask = { taskId, isCompleted };
    const response = await fetch(`/tasks/${taskId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(updatedTask),
    });

    if (response.ok) {
      fetchTasks(); // Refresh the tasks list after updating task status
    }
  }

  async function deleteTask(taskId) {
    const response = await fetch(`/tasks/${taskId}`, {
      method: 'DELETE',
    });

    if (response.ok) {
      fetchTasks(); // Refresh the tasks list after deleting the task
    } else {
      console.error('Failed to delete task');
    }
  }

  // Fetch tasks when the page loads
  fetchTasks();
</script>

</body>
</html>